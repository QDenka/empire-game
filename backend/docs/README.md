# TON Empire Backend Documentation

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–î–∞–Ω–Ω–∞—è –ø–∞–ø–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ backend'—É –∏–≥—Ä—ã TON Empire.

### üìö –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

#### üöÄ [API Documentation](./API.md)
–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è REST API —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤:
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (—Ä–∞–π–æ–Ω—ã, –∑–¥–∞–Ω–∏—è, —Ä–µ—Å—É—Ä—Å—ã)
- –ì–∏–ª—å–¥–∏–∏ –∏ PvP –±–∏—Ç–≤—ã
- –†–µ–π—Ç–∏–Ω–≥–∏ –∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥—ã
- –ö–æ–¥—ã –æ—à–∏–±–æ–∫ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞

#### üîå [WebSocket API](./WEBSOCKET.md)
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ real-time API —á–µ—Ä–µ–∑ WebSocket:
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- –°–æ–±—ã—Ç–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∫ –∫–ª–∏–µ–Ω—Ç—É
- –°–æ–±—ã—Ç–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–∞–º–∏
- –ü—Ä–∏–º–µ—Ä—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

#### üõ†Ô∏è [OpenAPI Specification](./api.yaml)
–ú–∞—à–∏–Ω–æ—á–∏—Ç–∞–µ–º–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è API –≤ —Ñ–æ—Ä–º–∞—Ç–µ OpenAPI 3.0:
- –ò–º–ø–æ—Ä—Ç –≤ Postman/Insomnia
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–æ–¥–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### üöÄ [Deployment Guide](./DEPLOYMENT.md)
–ü–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é:
- –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- Docker –∏ Docker Compose
- Kubernetes
- Production deployment
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ü—Ä–æ—Å–º–æ—Ç—Ä API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
```bash
# –í –±—Ä–∞—É–∑–µ—Ä–µ –æ—Ç–∫—Ä–æ–π—Ç–µ
open docs/API.md

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Swagger UI
docker run -p 8081:8080 -e SWAGGER_JSON=/docs/api.yaml -v $(pwd)/docs:/docs swaggerapi/swagger-ui
# –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8081
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API
```bash
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ Postman
# File -> Import -> docs/api.yaml

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ curl
curl -X POST http://localhost:8080/api/auth/telegram \
  -H "Content-Type: application/json" \
  -d '{"initData": "user=..."}'
```

### 3. WebSocket —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ wscat
npm install -g wscat

# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ WebSocket
wscat -c "ws://localhost:8080/ws?token=your_jwt_token"

# –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
> {"type": "join_room", "data": {"room": "user_123"}}
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ API

### –°–µ—Ä–≤–∏—Å—ã
- **API Gateway** (`:8080`) - –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
- **Auth Service** (`:8081`) - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- **User Service** (`:8082`) - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- **Game Service** (`:8083`) - –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞

### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

#### üîê Authentication
- `POST /api/auth/telegram` - –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram
- `POST /api/auth/refresh` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞

#### üë§ Users
- `GET /api/users/me` - –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
- `PUT /api/users/me` - –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
- `GET /api/users/{id}` - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### üèóÔ∏è Game - Districts & Buildings
- `GET /api/game/districts/my` - –ú–æ–π —Ä–∞–π–æ–Ω
- `POST /api/game/districts/my` - –°–æ–∑–¥–∞—Ç—å —Ä–∞–π–æ–Ω
- `GET /api/game/districts/{id}/buildings` - –ó–¥–∞–Ω–∏—è —Ä–∞–π–æ–Ω–∞
- `POST /api/game/districts/{id}/buildings` - –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∑–¥–∞–Ω–∏–µ
- `POST /api/game/buildings/{id}/upgrade` - –£–ª—É—á—à–∏—Ç—å –∑–¥–∞–Ω–∏–µ
- `DELETE /api/game/buildings/{id}` - –°–Ω–µ—Å—Ç–∏ –∑–¥–∞–Ω–∏–µ

#### üí∞ Game - Resources
- `POST /api/game/resources/collect` - –°–æ–±—Ä–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã

#### üèõÔ∏è Guilds
- `GET /api/game/guilds` - –ü–æ–∏—Å–∫ –≥–∏–ª—å–¥–∏–π
- `POST /api/game/guilds` - –°–æ–∑–¥–∞—Ç—å –≥–∏–ª—å–¥–∏—é

#### ‚öîÔ∏è Battle
- `POST /api/game/battles/search` - –ù–∞–π—Ç–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤
- `POST /api/game/battles/{id}/attack` - –ê—Ç–∞–∫–æ–≤–∞—Ç—å

#### üèÜ Leaderboard
- `GET /api/game/leaderboard/players` - –†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤
- `GET /api/game/leaderboard/guilds` - –†–µ–π—Ç–∏–Ω–≥ –≥–∏–ª—å–¥–∏–π

## WebSocket –°–æ–±—ã—Ç–∏—è

### üì• –û—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∫ –∫–ª–∏–µ–Ω—Ç—É
- `resource_update` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- `building_update` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–¥–∞–Ω–∏—è
- `building_created` - –ó–¥–∞–Ω–∏–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ
- `battle_started` - –ë–∏—Ç–≤–∞ –Ω–∞—á–∞–ª–∞—Å—å
- `battle_ended` - –ë–∏—Ç–≤–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- `notification` - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- `guild_invitation` - –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –≥–∏–ª—å–¥–∏—é

### üì§ –û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É
- `join_room` - –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
- `leave_room` - –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É
- `ping` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

## –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### User
```json
{
  "id": "uuid",
  "telegram_id": "string",
  "username": "string",
  "first_name": "string",
  "last_name": "string",
  "level": 5,
  "experience": 1250,
  "power": 2500,
  "battle_stats": {
    "wins": 10,
    "losses": 3,
    "rating": 1450
  }
}
```

### District
```json
{
  "id": "uuid",
  "name": "My Empire",
  "population": 150,
  "efficiency": 85,
  "resources": {
    "gold": 2500,
    "wood": 1200,
    "stone": 800,
    "food": 600,
    "energy": 200
  }
}
```

### Building
```json
{
  "id": "uuid",
  "type": "house",
  "level": 3,
  "health": 80,
  "max_health": 100,
  "position": {"x": 2, "y": 2},
  "is_active": true,
  "upgrade_end_at": null
}
```

## –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

–í—Å–µ API –∑–∞–ø—Ä–æ—Å—ã (–∫—Ä–æ–º–µ `/auth/*`) —Ç—Ä–µ–±—É—é—Ç JWT —Ç–æ–∫–µ–Ω:

```bash
Authorization: Bearer <jwt_token>
```

–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞:
```bash
POST /api/auth/telegram
{
  "initData": "user=%7B%22id%22%3A123456789..."
}
```

## Rate Limiting

- **Auth endpoints**: 10 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
- **Game endpoints**: 100 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É  
- **WebSocket**: –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

## –ö–æ–¥—ã –æ—à–∏–±–æ–∫

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| 400 | Bad Request |
| 401 | Unauthorized |
| 403 | Forbidden |
| 404 | Not Found |
| 409 | Conflict |
| 429 | Too Many Requests |
| 500 | Internal Server Error |

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### JavaScript/TypeScript
```javascript
// –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
const response = await fetch('/api/auth/telegram', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ initData: telegramInitData })
});
const { access_token } = await response.json();

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API
const userResponse = await fetch('/api/users/me', {
  headers: { 'Authorization': `Bearer ${access_token}` }
});
const user = await userResponse.json();

// WebSocket
const ws = new WebSocket(`ws://localhost:8080/ws?token=${access_token}`);
ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  console.log('Received:', message);
};
```

### Python
```python
import requests
import websocket
import json

# –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
auth_response = requests.post('http://localhost:8080/api/auth/telegram', 
    json={'initData': telegram_init_data})
token = auth_response.json()['access_token']

# API –∑–∞–ø—Ä–æ—Å
headers = {'Authorization': f'Bearer {token}'}
user_response = requests.get('http://localhost:8080/api/users/me', headers=headers)
user = user_response.json()

# WebSocket
def on_message(ws, message):
    data = json.loads(message)
    print(f"Received: {data}")

ws = websocket.WebSocketApp(f"ws://localhost:8080/ws?token={token}",
                           on_message=on_message)
ws.run_forever()
```

### Go
```go
package main

import (
    "encoding/json"
    "fmt"
    "net/http"
    "strings"
)

type AuthRequest struct {
    InitData string `json:"initData"`
}

type AuthResponse struct {
    AccessToken string `json:"access_token"`
}

func main() {
    // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    authReq := AuthRequest{InitData: telegramInitData}
    authBody, _ := json.Marshal(authReq)
    
    resp, err := http.Post("http://localhost:8080/api/auth/telegram",
        "application/json", strings.NewReader(string(authBody)))
    
    var authResp AuthResponse
    json.NewDecoder(resp.Body).Decode(&authResp)
    
    // API –∑–∞–ø—Ä–æ—Å
    req, _ := http.NewRequest("GET", "http://localhost:8080/api/users/me", nil)
    req.Header.Set("Authorization", "Bearer "+authResp.AccessToken)
    
    client := &http.Client{}
    userResp, _ := client.Do(req)
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞...
}
```

## –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### Postman Collection
–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ `docs/api.yaml` –≤ Postman –¥–ª—è –≥–æ—Ç–æ–≤–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.

### Swagger UI
```bash
docker run -p 8081:8080 \
  -e SWAGGER_JSON=/docs/api.yaml \
  -v $(pwd)/docs:/docs \
  swaggerapi/swagger-ui
```

### Insomnia
–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –∏–∑ `docs/api.yaml`.

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã

- **Email**: dev@ton-empire.com
- **GitHub**: https://github.com/ton-empire/backend
- **Telegram**: @ton_empire_support
- **Discord**: https://discord.gg/ton-empire

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

### v1.0.0 (2024-01-15)
- –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑ API
- REST endpoints –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- WebSocket real-time API
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
- –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –Ø–Ω–≤–∞—Ä—å 2024
**–í–µ—Ä—Å–∏—è API**: 1.0.0